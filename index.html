<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrickTree ‚Äî Skateboarding Skill Tree & Progression Tracker</title>
  <meta name="description" content="Track your skateboarding progression with an interactive skill tree. Unlock tricks, see prerequisites, and visualize your journey from pushing to tre flips.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå≥</text></svg>">
  <style>
    :root {
      --bg: #0f0f0f;
      --surface: #1a1a1a;
      --surface2: #252525;
      --border: #333;
      --text: #e8e8e8;
      --text-dim: #888;
      --green: #4ade80;
      --green-dim: #166534;
      --blue: #60a5fa;
      --purple: #a78bfa;
      --orange: #fb923c;
      --red: #f87171;
      --yellow: #facc15;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      text-align: center;
      padding: 2rem 1rem 1rem;
      border-bottom: 1px solid var(--border);
    }
    header h1 { font-size: 2rem; margin-bottom: 0.25rem; }
    header h1 span { color: var(--green); }
    header p { color: var(--text-dim); font-size: 0.95rem; }
    .stats-bar {
      display: flex;
      justify-content: center;
      gap: 2rem;
      padding: 1rem;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .stat { text-align: center; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--green); }
    .stat-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.05em; }
    .controls {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      padding: 1rem;
      flex-wrap: wrap;
    }
    .controls button {
      padding: 0.5rem 1rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
    }
    .controls button:hover { border-color: var(--green); }
    .controls button.active { background: var(--green-dim); border-color: var(--green); color: var(--green); }
    .search-bar {
      max-width: 600px;
      margin: 0 auto;
      padding: 0 1rem 0.5rem;
    }
    .search-bar input {
      width: 100%;
      padding: 0.65rem 1rem;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      border-radius: 8px;
      font-size: 0.95rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-bar input:focus { border-color: var(--green); }
    .search-bar input::placeholder { color: var(--text-dim); }
    .tree-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    .category-section { margin-bottom: 2rem; }
    .category-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .category-icon { font-size: 1.2rem; }
    .tricks-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 0.75rem;
    }
    .trick-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .trick-card:hover { border-color: var(--blue); transform: translateY(-2px); }
    .trick-card.unlocked { border-color: var(--green); background: linear-gradient(135deg, var(--surface), var(--green-dim)); }
    .trick-card.locked { opacity: 0.4; cursor: not-allowed; }
    .trick-card.available { border-color: var(--yellow); border-style: dashed; }
    .trick-name { font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem; }
    .trick-diff {
      display: inline-flex;
      gap: 2px;
      margin-bottom: 0.5rem;
    }
    .trick-diff .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
    }
    .trick-diff .dot.filled { background: var(--orange); }
    .trick-desc {
      font-size: 0.8rem;
      color: var(--text-dim);
      line-height: 1.4;
      margin-bottom: 0.5rem;
    }
    .trick-prereqs {
      font-size: 0.7rem;
      color: var(--text-dim);
    }
    .trick-prereqs span { color: var(--blue); }
    .trick-check {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      font-size: 1.2rem;
    }
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }
    .modal-overlay.open { display: flex; }
    .modal {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      max-width: 450px;
      width: 100%;
      padding: 1.5rem;
    }
    .modal h2 { margin-bottom: 0.5rem; }
    .modal .desc { color: var(--text-dim); margin-bottom: 1rem; line-height: 1.5; }
    .modal .tips { background: var(--surface); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem; line-height: 1.5; }
    .modal .tips strong { color: var(--yellow); }
    .modal .video-embed { margin-bottom: 1rem; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; }
    .modal .video-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; border-radius: 8px; }
    .modal .video-link { display: inline-flex; align-items: center; gap: 0.4rem; background: var(--surface); padding: 0.5rem 0.75rem; border-radius: 8px; margin-bottom: 1rem; color: var(--blue); text-decoration: none; font-size: 0.9rem; transition: background 0.2s; }
    .modal .video-link:hover { background: var(--border); }
    .trick-card .video-badge { position: absolute; bottom: 0.5rem; right: 0.5rem; font-size: 0.85rem; opacity: 0.6; }
    .stance-badge { font-size: 0.6rem; padding: 0.1rem 0.35rem; border-radius: 4px; text-transform: uppercase; font-weight: 700; letter-spacing: 0.05em; vertical-align: middle; }
    .stance-nollie { background: #7c3aed; color: #fff; }
    .stance-switch { background: #dc2626; color: #fff; }
    .stance-fakie { background: #0891b2; color: #fff; }
    .modal .prereq-list { margin-bottom: 1rem; }
    .modal .prereq-list span { display: inline-block; background: var(--surface); padding: 0.25rem 0.5rem; border-radius: 4px; margin: 0.25rem; font-size: 0.85rem; }
    .modal .prereq-list span.done { color: var(--green); }
    .modal .prereq-list span.pending { color: var(--red); }
    .modal-actions { display: flex; gap: 0.5rem; }
    .modal-actions button {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
    }
    .btn-unlock { background: var(--green); color: #000; }
    .btn-lock { background: var(--surface); color: var(--text); border: 1px solid var(--border) !important; }
    .btn-close { background: var(--surface); color: var(--text-dim); }
    .btn-disabled { background: var(--surface); color: var(--text-dim); cursor: not-allowed; opacity: 0.5; }
    /* Tree View */
    .tree-view { position: relative; overflow-x: auto; padding: 2rem 1rem; }
    .tree-svg { display: block; margin: 0 auto; }
    .tree-svg line {
      stroke: var(--border);
      stroke-width: 2;
      transition: stroke 0.3s;
    }
    .tree-svg line.lit { stroke: var(--green); stroke-width: 2.5; }
    .tree-svg line.available-edge { stroke: var(--yellow); stroke-dasharray: 6 3; stroke-width: 2; }
    .tree-node {
      cursor: pointer;
      transition: transform 0.15s;
    }
    .tree-node:hover { filter: brightness(1.2); }
    .tree-node rect {
      rx: 10;
      ry: 10;
      stroke-width: 2;
      transition: all 0.2s;
    }
    .tree-node rect.node-locked { fill: var(--surface); stroke: var(--border); opacity: 0.45; }
    .tree-node rect.node-unlocked { fill: var(--green-dim); stroke: var(--green); }
    .tree-node rect.node-available { fill: var(--surface); stroke: var(--yellow); stroke-dasharray: 6 3; }
    .tree-node text { fill: var(--text); font-size: 13px; font-family: inherit; pointer-events: none; }
    .tree-node text.node-label-locked { opacity: 0.45; }
    .tree-node .node-check { font-size: 14px; }
    .tree-node .node-diff-dot { transition: fill 0.2s; }

    footer { text-align: center; padding: 2rem; color: var(--text-dim); font-size: 0.8rem; }
    footer a { color: var(--blue); text-decoration: none; }
  </style>
</head>
<body>
  <header>
    <h1>üå≥ Trick<span>Tree</span></h1>
    <p>Track your skateboarding progression ‚Äî unlock tricks as you learn them</p>
  </header>
  <div class="stats-bar" id="stats"></div>
  <div class="controls" id="controls"></div>
  <div class="share-controls" style="display:flex;justify-content:center;gap:0.5rem;padding:0 1rem 0.75rem;flex-wrap:wrap">
    <button onclick="exportJSON()" style="padding:0.4rem 0.8rem;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:6px;cursor:pointer;font-size:0.8rem">üì• Export JSON</button>
    <button onclick="exportURL()" style="padding:0.4rem 0.8rem;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:6px;cursor:pointer;font-size:0.8rem">üîó Share Link</button>
    <button onclick="importJSON()" style="padding:0.4rem 0.8rem;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:6px;cursor:pointer;font-size:0.8rem">üì§ Import JSON</button>
  </div>
  <div class="search-bar">
    <input type="text" id="search" placeholder="üîç Search tricks by name, category, or difficulty (1-10)..." oninput="onSearch(this.value)">
  </div>
  <div class="tree-container" id="tree"></div>
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal"></div>
  </div>
  <footer>
    <p>TrickTree ‚Äî Your progress is saved locally in your browser.</p>
    <p style="margin-top:0.5rem"><a href="https://github.com/clawdiard/tricktree">GitHub</a></p>
  </footer>
  <script>
    const CATEGORIES = {
      basics: { name: 'Basics', icon: 'üõπ' },
      fundamentals: { name: 'Fundamentals', icon: '‚≠ê' },
      flips: { name: 'Flip Tricks', icon: 'üîÑ' },
      grinds: { name: 'Grinds & Slides', icon: '‚ö°' },
      transition: { name: 'Transition', icon: 'üèÑ' }
    };
    let tricks = [];
    let unlocked = JSON.parse(localStorage.getItem('tricktree-unlocked') || '[]');

    // Import from URL hash on load
    (function importFromHash() {
      const hash = window.location.hash;
      if (hash.startsWith('#progress=')) {
        try {
          const data = JSON.parse(decodeURIComponent(hash.slice('#progress='.length)));
          if (Array.isArray(data) && data.length) {
            unlocked = data;
            localStorage.setItem('tricktree-unlocked', JSON.stringify(unlocked));
            history.replaceState(null, '', window.location.pathname);
          }
        } catch(e) { console.warn('Invalid progress hash', e); }
      }
    })();
    let filter = 'all';
    let searchQuery = '';
    let viewMode = 'grid'; // 'grid' or 'tree'

    function save() { localStorage.setItem('tricktree-unlocked', JSON.stringify(unlocked)); }

    function exportJSON() {
      const blob = new Blob([JSON.stringify(unlocked, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tricktree-progress.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function exportURL() {
      const url = window.location.origin + window.location.pathname + '#progress=' + encodeURIComponent(JSON.stringify(unlocked));
      navigator.clipboard.writeText(url).then(() => {
        showToast('üìã Share link copied to clipboard!');
      }).catch(() => {
        prompt('Copy this link:', url);
      });
    }

    function importJSON() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try {
            const data = JSON.parse(ev.target.result);
            if (!Array.isArray(data)) throw new Error('Not an array');
            unlocked = data;
            save();
            render();
            showToast(`‚úÖ Imported ${data.length} tricks!`);
          } catch(err) { showToast('‚ùå Invalid file'); }
        };
        reader.readAsText(file);
      };
      input.click();
    }

    function showToast(msg) {
      let t = document.getElementById('toast');
      if (!t) { t = document.createElement('div'); t.id = 'toast'; document.body.appendChild(t); }
      t.textContent = msg;
      t.style.cssText = 'position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:#1a1a1a;color:#e8e8e8;padding:0.75rem 1.5rem;border-radius:8px;border:1px solid #4ade80;z-index:10000;font-size:0.9rem;transition:opacity 0.3s';
      t.style.opacity = '1';
      setTimeout(() => { t.style.opacity = '0'; }, 2500);
    }

    function isUnlocked(id) { return unlocked.includes(id); }
    function canUnlock(t) { return t.prereqs.every(p => isUnlocked(p)); }

    function getStatus(t) {
      if (isUnlocked(t.id)) return 'unlocked';
      if (canUnlock(t)) return 'available';
      return 'locked';
    }

    function renderStats() {
      const total = tricks.length;
      const done = unlocked.length;
      const avail = tricks.filter(t => !isUnlocked(t.id) && canUnlock(t)).length;
      const pct = total ? Math.round(done / total * 100) : 0;
      document.getElementById('stats').innerHTML = `
        <div class="stat"><div class="stat-value">${done}/${total}</div><div class="stat-label">Tricks Unlocked</div></div>
        <div class="stat"><div class="stat-value">${pct}%</div><div class="stat-label">Complete</div></div>
        <div class="stat"><div class="stat-value">${avail}</div><div class="stat-label">Ready to Learn</div></div>
      `;
    }

    function renderControls() {
      const cats = ['all', ...Object.keys(CATEGORIES)];
      const viewBtns = `<button class="${viewMode==='grid'?'active':''}" onclick="setView('grid')">üìã Grid</button><button class="${viewMode==='tree'?'active':''}" onclick="setView('tree')">üå≥ Skill Tree</button>`;
      document.getElementById('controls').innerHTML = viewBtns + '<span style="width:1px;height:24px;background:var(--border);margin:0 0.25rem"></span>' + cats.map(c =>
        `<button class="${filter === c ? 'active' : ''}" onclick="setFilter('${c}')">${c === 'all' ? 'üéØ All' : CATEGORIES[c].icon + ' ' + CATEGORIES[c].name}</button>`
      ).join('');
    }

    function setView(v) { viewMode = v; render(); }

    function onSearch(q) { searchQuery = q.trim().toLowerCase(); renderTree(); }

    function setFilter(f) { filter = f; renderControls(); renderTree(); }

    function renderTree() {
      if (viewMode === 'tree') return renderSkillTree();
      renderGridView();
    }

    function renderGridView() {
      const container = document.getElementById('tree');
      const cats = filter === 'all' ? Object.keys(CATEGORIES) : [filter];
      container.innerHTML = cats.map(cat => {
        const catTricks = tricks.filter(t => t.category === cat).filter(t => {
          if (!searchQuery) return true;
          return t.name.toLowerCase().includes(searchQuery)
            || t.category.toLowerCase().includes(searchQuery)
            || (CATEGORIES[t.category]?.name||'').toLowerCase().includes(searchQuery)
            || String(t.difficulty) === searchQuery
            || (t.stance && t.stance.toLowerCase().includes(searchQuery));
        });
        if (!catTricks.length) return '';
        return `
          <div class="category-section">
            <div class="category-title"><span class="category-icon">${CATEGORIES[cat].icon}</span> ${CATEGORIES[cat].name}</div>
            <div class="tricks-grid">
              ${catTricks.map(t => {
                const status = getStatus(t);
                return `
                  <div class="trick-card ${status}" onclick="${status !== 'locked' ? `openModal('${t.id}')` : ''}">
                    ${status === 'unlocked' ? '<div class="trick-check">‚úÖ</div>' : ''}
                    <div class="trick-name">${t.stance ? t.name.replace(new RegExp('^' + t.stance + '\\s*', 'i'), '') : t.name}${t.stance ? ` <span class="stance-badge stance-${t.stance}">${t.stance}</span>` : ''}</div>
                    <div class="trick-diff">${Array.from({length: 10}, (_, i) => `<div class="dot ${i < t.difficulty ? 'filled' : ''}"></div>`).join('')}</div>
                    <div class="trick-desc">${t.description}</div>
                    ${t.prereqs.length ? `<div class="trick-prereqs">Requires: ${t.prereqs.map(p => `<span>${tricks.find(x=>x.id===p)?.name||p}</span>`).join(', ')}</div>` : ''}
                    ${t.videoUrl ? '<div class="video-badge">üé¨</div>' : ''}
                  </div>`;
              }).join('')}
            </div>
          </div>`;
      }).join('');
    }

    function renderSkillTree() {
      const container = document.getElementById('tree');
      // Filter tricks by category
      const cats = filter === 'all' ? Object.keys(CATEGORIES) : [filter];
      const filtered = tricks.filter(t => cats.includes(t.category)).filter(t => {
        if (!searchQuery) return true;
        return t.name.toLowerCase().includes(searchQuery)
          || t.category.toLowerCase().includes(searchQuery)
          || (CATEGORIES[t.category]?.name||'').toLowerCase().includes(searchQuery)
          || String(t.difficulty) === searchQuery;
      });
      if (!filtered.length) { container.innerHTML = '<p style="text-align:center;color:var(--text-dim);padding:3rem">No tricks match your filter.</p>'; return; }
      const filteredIds = new Set(filtered.map(t => t.id));

      // Compute depth (longest path from root)
      const depthOf = {};
      function computeDepth(t) {
        if (depthOf[t.id] !== undefined) return depthOf[t.id];
        if (!t.prereqs.length || t.prereqs.every(p => !filteredIds.has(p))) { depthOf[t.id] = 0; return 0; }
        const d = 1 + Math.max(...t.prereqs.filter(p => filteredIds.has(p)).map(pid => computeDepth(tricks.find(x => x.id === pid))));
        depthOf[t.id] = d;
        return d;
      }
      filtered.forEach(t => computeDepth(t));

      // Group by depth
      const layers = {};
      filtered.forEach(t => { (layers[depthOf[t.id]] = layers[depthOf[t.id]] || []).push(t); });
      const maxDepth = Math.max(...Object.keys(layers).map(Number));

      // Layout params
      const nodeW = 150, nodeH = 52, padX = 40, padY = 80;
      const maxCols = Math.max(...Object.values(layers).map(l => l.length));
      const svgW = Math.max(600, maxCols * (nodeW + padX) + padX);
      const svgH = (maxDepth + 1) * (nodeH + padY) + padY * 2;

      // Assign positions
      const pos = {};
      for (let d = 0; d <= maxDepth; d++) {
        const row = layers[d] || [];
        const totalW = row.length * nodeW + (row.length - 1) * padX;
        const startX = (svgW - totalW) / 2;
        row.forEach((t, i) => {
          pos[t.id] = {
            x: startX + i * (nodeW + padX),
            y: padY + d * (nodeH + padY),
            cx: startX + i * (nodeW + padX) + nodeW / 2,
            cy: padY + d * (nodeH + padY) + nodeH / 2
          };
        });
      }

      // Build SVG
      let lines = '';
      let nodes = '';
      const catColors = { basics: '#4ade80', fundamentals: '#60a5fa', flips: '#a78bfa', grinds: '#fb923c', transition: '#f87171' };

      // Draw edges
      filtered.forEach(t => {
        t.prereqs.filter(p => filteredIds.has(p)).forEach(pid => {
          const from = pos[pid], to = pos[t.id];
          if (!from || !to) return;
          const bothUnlocked = isUnlocked(pid) && isUnlocked(t.id);
          const avail = isUnlocked(pid) && !isUnlocked(t.id) && canUnlock(t);
          const cls = bothUnlocked ? 'lit' : avail ? 'available-edge' : '';
          lines += `<line x1="${from.cx}" y1="${from.cy + nodeH/2}" x2="${to.cx}" y2="${to.cy - nodeH/2}" class="${cls}"/>`;
        });
      });

      // Draw nodes
      filtered.forEach(t => {
        const p = pos[t.id];
        if (!p) return;
        const status = getStatus(t);
        const rectCls = status === 'unlocked' ? 'node-unlocked' : status === 'available' ? 'node-available' : 'node-locked';
        const textCls = status === 'locked' ? 'node-label-locked' : '';
        const clickHandler = status !== 'locked' ? `openModal('${t.id}')` : '';
        // Difficulty dots
        let dots = '';
        for (let i = 0; i < 10; i++) {
          dots += `<circle class="node-diff-dot" cx="${p.x + 15 + i * 12}" cy="${p.y + nodeH - 10}" r="3" fill="${i < t.difficulty ? (catColors[t.category] || '#fb923c') : '#333'}"/>`;
        }
        const check = status === 'unlocked' ? `<text class="node-check" x="${p.x + nodeW - 20}" y="${p.y + 18}">‚úÖ</text>` : '';
        nodes += `<g class="tree-node" onclick="${clickHandler}">
          <rect class="${rectCls}" x="${p.x}" y="${p.y}" width="${nodeW}" height="${nodeH}"/>
          <text class="${textCls}" x="${p.cx}" y="${p.y + 22}" text-anchor="middle" font-weight="600">${t.name.length > 16 ? t.name.slice(0,15)+'‚Ä¶' : t.name}</text>
          ${dots}${check}
        </g>`;
      });

      container.innerHTML = `<div class="tree-view"><svg class="tree-svg" viewBox="0 0 ${svgW} ${svgH}" preserveAspectRatio="xMidYMin meet" style="width:100%;height:auto;max-height:80vh">${lines}${nodes}</svg></div>`;
    }

    function renderVideo(url) {
      // YouTube embed
      const ytMatch = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]+)/);
      if (ytMatch) {
        return `<div class="video-embed"><iframe src="https://www.youtube.com/embed/${ytMatch[1]}" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>`;
      }
      // Instagram - can't embed easily, link out
      if (url.includes('instagram.com')) {
        return `<a class="video-link" href="${url}" target="_blank" rel="noopener">üì∏ Watch on Instagram ‚Üó</a>`;
      }
      // Fallback: link
      return `<a class="video-link" href="${url}" target="_blank" rel="noopener">üé¨ Watch Video ‚Üó</a>`;
    }

    function openModal(id) {
      const t = tricks.find(x => x.id === id);
      if (!t) return;
      const status = getStatus(t);
      const isU = isUnlocked(t.id);
      document.getElementById('modal').innerHTML = `
        <h2>${t.name}</h2>
        <div class="desc">${t.description}</div>
        <div class="tips"><strong>üí° Tips:</strong> ${t.tips}</div>
        ${t.videoUrl ? renderVideo(t.videoUrl) : ''}
        ${t.prereqs.length ? `<div class="prereq-list"><strong>Prerequisites:</strong><br>${t.prereqs.map(p => {
          const pt = tricks.find(x=>x.id===p);
          return `<span class="${isUnlocked(p)?'done':'pending'}">${isUnlocked(p)?'‚úÖ':'‚ùå'} ${pt?.name||p}</span>`;
        }).join('')}</div>` : ''}
        <div class="modal-actions">
          ${isU
            ? `<button class="btn-lock" onclick="toggleTrick('${t.id}')">üîí Unlearn</button>`
            : canUnlock(t)
              ? `<button class="btn-unlock" onclick="toggleTrick('${t.id}')">üéâ Mark as Learned!</button>`
              : `<button class="btn-disabled" disabled>üîí Prerequisites needed</button>`
          }
          <button class="btn-close" onclick="closeModal()">Close</button>
        </div>
      `;
      document.getElementById('modal-overlay').classList.add('open');
    }

    function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); }
    document.getElementById('modal-overlay').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

    function toggleTrick(id) {
      if (isUnlocked(id)) {
        // also unlearn anything that depends on this
        const deps = getDependents(id);
        unlocked = unlocked.filter(u => u !== id && !deps.includes(u));
      } else {
        unlocked.push(id);
      }
      save(); render(); closeModal();
    }

    function getDependents(id) {
      const direct = tricks.filter(t => t.prereqs.includes(id)).map(t => t.id);
      return direct.reduce((acc, d) => [...acc, d, ...getDependents(d)], []);
    }

    function render() { renderStats(); renderControls(); renderTree(); }

    fetch('data/tricks.json')
      .then(r => r.json())
      .then(data => { tricks = data; render(); });
  </script>
</body>
</html>
